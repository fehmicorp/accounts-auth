name: Deploy Production Image

on:
  push:
    branches:
      - prod   # Trigger only when prod branch is updated

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: fehmicorp/accounts-auth

    steps:
      # -----------------------------
      #  STEP 1 — CHECKOUT CODE
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      #  STEP 2 — READ VERSION
      # -----------------------------
      - name: Read version
        id: version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_ENV

      # -----------------------------
      #  STEP 3 — SETUP DOCKER LOGIN
      # -----------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # -----------------------------
      #  STEP 4 — BUILD DOCKER IMAGE
      # -----------------------------
      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME:prod_v${VERSION} .
          docker tag $IMAGE_NAME:prod_v${VERSION} $IMAGE_NAME:latest

      # -----------------------------
      #  STEP 5 — PUSH DOCKER IMAGE
      # -----------------------------
      - name: Push Docker image
        run: |
          docker push $IMAGE_NAME:prod_v${VERSION}
          docker push $IMAGE_NAME:latest

      # -----------------------------
      #  STEP 6 — SSH DEPLOY TO SERVER
      # -----------------------------
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "Pulling new prod image..."
            docker pull fehmicorp/accounts-auth:prod_v${VERSION}

            echo "Stopping old container..."
            docker stop accounts-auth || true
            docker rm accounts-auth || true

            echo "Starting updated container..."
            docker run -d \
              --name accounts-auth \
              -p 4000:4000 \
              fehmicorp/accounts-auth:prod_v${VERSION}

            echo "Deployment Completed!"
